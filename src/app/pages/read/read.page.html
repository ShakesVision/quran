<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title> {{title}} </ion-title>
    <ion-buttons slot="end">
      <ion-button
        (click)="toggleHifzMode()"
        slot="end"
        [ngClass]="!hMode?'emphasize-btn':''"
      >
        <ion-icon
          slot="icon-only"
          [name]="hMode?toggleIconOutline('eye'):toggleIconOutline('eye-outline')"
        ></ion-icon>
      </ion-button>
      <ion-button
        *ngIf="translationExists"
        (click)="translationMode(true)"
        slot="end"
        [ngClass]="tMode?'emphasize-btn':''"
      >
        <ion-icon
          slot="icon-only"
          [name]="tMode?toggleIconOutline('language-outline'):toggleIconOutline('language')"
        ></ion-icon>
      </ion-button>

      <ion-button id="popover-trigger-button" slot="end">
        <ion-icon slot="icon-only" name="ellipsis-vertical-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="page-wrapper ar ar2 ion-margin-top">
    <div class="page-top-info">
      <ng-container *ngIf="(currentPage>1 && isCompleteMushaf) || juzmode">
        <span class="juz-number">
          {{ isCompleteMushaf? (surahCalculated === 1? 'سورۃ' :
          (surahService.juzNames[juzCalculated-1] + ' ' +
          surahService.e2a(juzCalculated.toString()))) : (surahCalculatedForJuz
          === 1? 'سورۃ' : (surahService.juzNames[+title-1] + ' ' +
          surahService.e2a(title.toString()))) }}
        </span>
        <span class="page-number">
          {{ isCompleteMushaf? surahService.e2a(currentPage.toString()):
          surahService.e2a(currentPageCalculated.toString()) }}
        </span>
        <span class="surah-number">
          {{ isCompleteMushaf? surahService.surahNames[surahCalculated-1] + ' '
          + surahService.e2a(surahCalculated.toString()) :
          surahService.surahNames[surahCalculatedForJuz-1] + ' ' +
          surahService.e2a(surahCalculatedForJuz.toString())}}
        </span>
      </ng-container>
    </div>
    <div class="content-wrapper">
      <ng-container
        class="ion-text-center"
        *ngIf="currentPage==1 && lines?.length<15 && !juzmode"
      >
        <div
          class="filler-lines line"
          *ngFor="let line of [].constructor(15 - (lines?.length+2))"
        ></div>
        <div class="surah-name line centered-table-text">
          {{title?.split(' ')[1]}}
        </div>
        <div class="line bism centered-table-text">﷽</div>
      </ng-container>
      <div
        *ngFor="let line of lines;let i = index"
        id="line_{{i}}"
        class="line"
        style="position: relative"
        [ngClass]="{
        'quran-kareem-text':juzmode && isCompleteMushaf && currentPage==1,
        'bism-line': line?.trim()==='﷽' || (isCompleteMushaf && currentPage === pages.length && i==10), 
        'surah-start-line':lines[i+1]?.trim()==='﷽' || (surahCalculated===9 && currentPage==188 && i==0), 
        'surah-end-line':i===lines.length-1&&pages[currentPage]?.split('\n')[1]?.trim()==='﷽'||lines[i+2]?.trim()==='﷽' || (isCompleteMushaf && currentPage === pages.length && (i==lines.length-1 || i==9))|| (currentPage===pages.length && i===lines.length-1 && !juzmode)}"
        (click)="openTrans($event,i)"
      >
        <div
          *ngIf="line.includes(surahService.diacritics.RUKU_MARK)"
          class="ruku-wrapper"
          [innerHTML]="addIndicators(line,i)"
        ></div>
        <span> {{line}} </span>
      </div>
      <ng-container
        *ngIf="currentPage==pages?.length && pages?.length!=1 && lines.length<15"
      >
        <div
          class="filler-lines line"
          *ngFor="let line of [].constructor(15 - lines.length)"
        ></div>
      </ng-container>
    </div>
  </div>
  <!-- <div class="next-words ar ar2 ion-text-end">
    {{pages[currentPage]?.split("\n")[0].split(" ")[0]}}
  </div> -->

  <div class="popup ion-text-center">
    <div class="popup-header"></div>
    <div class="popup-text"></div>
    <ion-button
      style="font-size: x-small"
      fill="outline"
      size="small"
      color="dark"
      class="cross"
    >
      <ion-icon slot="icon-only" name="close"></ion-icon>
    </ion-button>
  </div>

  <ion-popover
    [isOpen]="isPopoverOpen"
    trigger="popover-trigger-button"
    side="bottom"
  >
    <ng-template>
      <ion-content #scrollingBlock>
        <div class="popover-wrapper">
          <ion-list lines="none">
            <ion-item>
              <ion-label>Font Size</ion-label>
              <ion-button (click)="changeFontSize(1)" slot="end" fill="clear">
                <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
              </ion-button>
              <!-- <ion-input
                slot="end"
                placeholder="px"
                (ionChange)="changeFontSize($event.target.value,true)"
                [debounce]="500"
                class="font-size-field ion-no-padding ion-no-margin ion-text-center"
              ></ion-input> -->
              <div slot="end" class="font-size-field"></div>
              <ion-button (click)="changeFontSize(-1)" slot="end" fill="clear">
                <ion-icon
                  slot="icon-only"
                  name="remove-circle-outline"
                ></ion-icon>
              </ion-button>
            </ion-item>
            <ion-item *ngIf="isCompleteMushaf">
              <ion-label>Go to</ion-label>
              <ng-container slot="end">
                <ion-input
                  slot="end"
                  placeholder="juz"
                  type="number"
                  maxlength="2"
                  (ionChange)="gotoJuzSurah($event.target.value,'juz')"
                  [debounce]="500"
                  class="ion-no-padding ion-no-margin ion-text-center"
                ></ion-input>
                <ion-input
                  slot="end"
                  placeholder="surah"
                  type="number"
                  maxlength="3"
                  (ionChange)="gotoJuzSurah($event.target.value,'surah')"
                  [debounce]="500"
                  class="ion-no-padding ion-no-margin ion-text-center"
                ></ion-input>
              </ng-container>
            </ion-item>
            <ion-item>
              <ion-label>Colors</ion-label>
              <ion-input
                placeholder="css color"
                (ionChange)="changeColors($event.target.value,'color')"
                [debounce]="1000"
                class="ion-no-padding ion-no-margin ion-text-center"
              ></ion-input>
              <ion-input
                placeholder="bg"
                (ionChange)="changeColors($event.target.value,'bg')"
                [debounce]="1000"
                class="ion-no-padding ion-no-margin ion-text-center"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label>Translation</ion-label>
              <ion-input
                #verseIdInput
                placeholder="2:125"
                (ionChange)="readTrans($event.target.value)"
                [debounce]="1000"
                class="ion-no-padding ion-no-margin ion-text-center"
              ></ion-input>
              <ion-select
                value="en"
                placeholder="Language"
                (ionChange)="readTrans(verseIdInput.value,$event.target.value)"
              >
                <ion-select-option value="en">English</ion-select-option>
                <ion-select-option value="ur">Urdu</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item button *ngIf="!juzmode" (click)="showSurahInfo()">
              <ion-icon slot="start" name="information"></ion-icon>
              <ion-label>About Surah</ion-label>
            </ion-item>
            <ion-item button (click)="toggleMuhammadiFont()">
              <ion-icon slot="start" name="refresh"></ion-icon>
              <ion-label>Change Font</ion-label>
            </ion-item>
            <ion-card>
              <ion-item color="light">
                <ion-input
                  placeholder="بحث / SEARCH / تلاش"
                  (ionChange)="onSearchChange($event)"
                  [debounce]="500"
                  clearInput
                  class="ion-no-padding ion-text-center ar2"
                ></ion-input>
              </ion-item>
              <ion-item style="font-size: small">
                <ion-label>Ignore Tashkeel</ion-label>
                <ion-toggle
                  slot="end"
                  [checked]="ignoreTashkeel"
                  (ionChange)="ignoreTashkeel=!ignoreTashkeel"
                ></ion-toggle>
              </ion-item>
            </ion-card>
            <div *ngIf="searchResults" class="ion-text-center result-heading">
              <ion-item
                button
                (click)="copyResults($event.target)"
                [color]="copyResultsBG"
              >
                <ion-label
                  >Results: {{searchResults.length}}
                  <small>⏲ {{searchTime}}</small>
                </ion-label>
                <ion-icon
                  color="light"
                  slot="end"
                  name="copy-outline"
                ></ion-icon>
              </ion-item>
              <ion-label
                *ngIf="!isCompleteMushaf"
                color="warning"
                style="font-style: italic"
              >
                <small>(searched only in Juz {{title}}) </small>
              </ion-label>
            </div>
            <virtual-scroller
              *ngIf="searchResults"
              #scroll
              [items]="searchResults"
              [parentScroll]="scrollingBlock.nativeElement"
              [executeRefreshOutsideAngularZone]="true"
              (vsUpdate)="changeDetectorRef.detectChanges()"
              (vsChange)="vsChange($event)"
            >
              <ion-item
                *ngFor="let r of scroll.viewPortItems;let i=index"
                button
                class="rtl"
                style="position: relative"
                (click)="gotoPageAndHighlightLine(r.pageIndex,r.lineIndex)"
              >
                <div class="indices ion-margin-end">
                  <span class="index">{{i+1+startIndex}}</span>
                  <span class="location">{{r.pageIndex+1}}</span>
                </div>
                <ion-label class="ar2 small-text"
                  >{{getLineTextFromIndices(+r.pageIndex,+r.lineIndex)}}</ion-label
                >
              </ion-item>
            </virtual-scroller>
          </ion-list>
        </div>
      </ion-content>
    </ng-template>
  </ion-popover>
</ion-content>
<ion-footer>
  <div class="btmNav">
    <ion-button
      shape="round"
      fill="clear"
      [disabled]="currentPage==pages?.length"
      (click)="goToPage(1)"
    >
      <ion-icon name="chevron-back-circle-outline"></ion-icon>
    </ion-button>
    <ion-label style="font-size: small"
      >Page
      <ion-input
        class="page-num-input"
        type="number"
        [ngModel]="currentPage"
        (keyup.enter)="gotoPageNum($event.target.value)"
      ></ion-input>
      of {{pages?.length}}
    </ion-label>
    <ion-button
      shape="round"
      fill="clear"
      [disabled]="currentPage==1"
      (click)="goToPage(-1)"
    >
      <ion-icon name="chevron-forward-circle-outline"></ion-icon>
    </ion-button>
  </div>
</ion-footer>
